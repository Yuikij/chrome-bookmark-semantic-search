document.addEventListener('DOMContentLoaded', () => {
    // --- å›¾ç‰‡é¢„è§ˆå¼¹çª—é€»è¾‘ (CSP å…¼å®¹ï¼šä¸ä½¿ç”¨ inline handler) ---
    const imageOverlay = document.getElementById('imagePreviewOverlay');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const imagePreviewLink = document.getElementById('imagePreviewLink');
    const imagePreviewClose = document.getElementById('imagePreviewClose');

    window.showImagePreview = function (url) {
        imagePreviewImg.src = url;
        imagePreviewLink.href = url;
        imageOverlay.style.display = 'flex';
    };

    // å…³é—­æŒ‰é’®
    imagePreviewClose.addEventListener('click', () => { imageOverlay.style.display = 'none'; });
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    imageOverlay.addEventListener('click', (e) => { if (e.target === imageOverlay) imageOverlay.style.display = 'none'; });
    // æ‚¬æµ®æ•ˆæœ
    imagePreviewLink.addEventListener('mouseover', () => { imagePreviewLink.style.background = 'rgba(255,255,255,0.2)'; });
    imagePreviewLink.addEventListener('mouseout', () => { imagePreviewLink.style.background = 'rgba(255,255,255,0.1)'; });

    // äº‹ä»¶å§”æ‰˜ï¼šæ•è·æ‰€æœ‰åŠ¨æ€ç”Ÿæˆçš„ç¼©ç•¥å›¾ç‚¹å‡»
    document.addEventListener('click', (e) => {
        const thumb = e.target.closest('.media-thumb');
        if (thumb) {
            e.preventDefault();
            e.stopPropagation();
            window.showImagePreview(thumb.src);
        }
    });

    // å¤´åƒåŠ è½½å¤±è´¥å›é€€ (CSP ä¸å…è®¸ inline onerror)
    document.addEventListener('error', (e) => {
        if (e.target.classList && e.target.classList.contains('avatar-img')) {
            e.target.style.display = 'none';
            if (e.target.nextElementSibling) e.target.nextElementSibling.style.display = 'flex';
        }
    }, true); // å¿…é¡»ç”¨æ•è·é˜¶æ®µï¼Œerror äº‹ä»¶ä¸å†’æ³¡

    // æ³¨å…¥ hover æ•ˆæœæ ·å¼ï¼ˆé¿å… inline onmouseoverï¼‰
    const hoverStyle = document.createElement('style');
    hoverStyle.textContent = '.media-thumb:hover { transform: scale(1.08) !important; }';
    document.head.appendChild(hoverStyle);

    // --- è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ ---
    const cOverlay = document.getElementById('cDialogOverlay');
    function closeDialog() {
        cOverlay.style.display = 'none';
        document.getElementById('cDialogInput').style.display = 'none';
        document.getElementById('cDialogCancel').style.display = 'inline-block';
        document.getElementById('cDialogInput').value = '';
    }

    function cAlert(msg, title = 'â„¹ï¸ æç¤º') {
        return new Promise(resolve => {
            document.getElementById('cDialogTitle').innerHTML = title;
            document.getElementById('cDialogMessage').innerHTML = msg;
            document.getElementById('cDialogCancel').style.display = 'none';
            cOverlay.style.display = 'flex';
            document.getElementById('cDialogConfirm').onclick = () => { closeDialog(); resolve(); };
        });
    }

    function cConfirm(msg, title = 'âš ï¸ ç¡®è®¤æ“ä½œ') {
        return new Promise(resolve => {
            document.getElementById('cDialogTitle').innerHTML = title;
            document.getElementById('cDialogMessage').innerHTML = msg;
            cOverlay.style.display = 'flex';
            document.getElementById('cDialogCancel').onclick = () => { closeDialog(); resolve(false); };
            document.getElementById('cDialogConfirm').onclick = () => { closeDialog(); resolve(true); };
        });
    }

    function cPrompt(msg, defaultText = '', title = 'âœï¸ è¾“å…¥ä¿¡æ¯') {
        console.log('ğŸ”µ [cPrompt] è¢«è°ƒç”¨, title:', title);
        return new Promise(resolve => {
            document.getElementById('cDialogTitle').innerHTML = title;
            document.getElementById('cDialogMessage').innerHTML = msg;
            const input = document.getElementById('cDialogInput');
            input.style.display = 'block';
            input.value = defaultText;
            cOverlay.style.display = 'flex';
            input.focus();
            console.log('ğŸ”µ [cPrompt] å¼¹çª—å·²æ˜¾ç¤º');
            document.getElementById('cDialogCancel').onclick = () => { console.log('ğŸ”µ [cPrompt] ç”¨æˆ·å–æ¶ˆ'); closeDialog(); resolve(null); };
            document.getElementById('cDialogConfirm').onclick = () => {
                const val = input.value; // âš ï¸ å¿…é¡»åœ¨ closeDialog ä¹‹å‰å–å€¼ï¼
                console.log('ğŸ”µ [cPrompt] ç”¨æˆ·ç¡®è®¤:', val);
                closeDialog();
                resolve(val);
            };
        });
    }

    const totalBookmarksEl = document.getElementById('totalBookmarks');
    const engineStatusEl = document.getElementById('engineStatus');
    const totalFoldersEl = document.getElementById('totalFolders');
    const totalXBookmarksEl = document.getElementById('totalXBookmarks');
    const indexViewEl = document.getElementById('indexView');
    const xListPane = document.getElementById('xListPane');
    const xDetailPane = document.getElementById('xDetailPane');
    const twActionControls = document.getElementById('twActionControls');

    // Theme logic
    const toggleBtn = document.getElementById('themeToggleBtn');
    if (toggleBtn) {
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', currentTheme);
        toggleBtn.innerHTML = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        toggleBtn.addEventListener('click', () => {
            let theme = document.documentElement.getAttribute('data-theme');
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            toggleBtn.innerHTML = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        });
    }
    const refreshBtn = document.getElementById('refreshBtn');
    const openTwitterBtn = document.getElementById('openTwitterBtn');

    // Drawer Logic
    const twDrawerOverlay = document.getElementById('twDrawerOverlay');
    const twDrawerPanel = document.getElementById('twDrawerPanel');
    const twDrawerClose = document.getElementById('twDrawerClose');

    window.closeTwDrawer = function () {
        if (twDrawerOverlay && twDrawerPanel) {
            twDrawerOverlay.classList.remove('open');
            twDrawerPanel.classList.remove('open');
        }
    }

    if (twDrawerClose) twDrawerClose.addEventListener('click', window.closeTwDrawer);
    if (twDrawerOverlay) twDrawerOverlay.addEventListener('click', window.closeTwDrawer);

    // Tab åˆ‡æ¢é€»è¾‘
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.getAttribute('data-target')).classList.add('active');
        });
    });

    refreshBtn.addEventListener('click', loadData);

    if (openTwitterBtn) {
        openTwitterBtn.addEventListener('click', () => {
            chrome.tabs.create({ url: 'https://x.com/i/bookmarks' });
        });
    }

    const forceReinitBtn = document.getElementById('forceReinitBtn');
    if (forceReinitBtn) {
        forceReinitBtn.addEventListener('click', async () => {
            const confirmed = await cConfirm('<b>è­¦å‘Šï¼šè¿™å°†ä¼šå®Œå…¨æ¸…é™¤å½“å‰çš„æ¨¡å‹ç¼“å­˜å’Œæ‰€æœ‰å·²è®¡ç®—å®Œæˆçš„ä¹¦ç­¾åµŒå…¥ç‰¹å¾ï¼Œå¹¶è§¦å‘é‡ç½®ã€‚</b><br><br>ç³»ç»Ÿå°†ä¼šæ¸…é™¤æœ¬åœ°å¼•æ“ç‰¹å¾ç´¢å¼•ï¼Œå¹¶è¿«ä½¿æµè§ˆå™¨é‡æ–°ä½¿ç”¨ BGE-Small-ZH æ¨¡å‹é‡æ–°å¤„ç†ä½ åº“é‡Œé‚£ 1000 å¤šæ¡ä¹¦ç­¾ã€‚<br><br>ç¡®å®šè¦æ‰§è¡Œç¡¬é‡å¯å—ï¼Ÿ', 'âš ï¸ å±é™©æ“ä½œ');
            if (confirmed) {
                forceReinitBtn.innerText = 'âš ï¸ æ­£åœ¨æ¸…ç©ºå¹¶é‡å¯å¼•æ“...';
                forceReinitBtn.disabled = true;
                chrome.runtime.sendMessage({ type: 'FORCE_REINIT_ENGINE' }, async (res) => {
                    if (res && res.success) {
                        await cAlert('âœ… æ—§ç¼“å­˜å·²å…¨éƒ¨æ¸…é™¤ï¼<br><br>è¯·å…³é—­æœ¬é¡µé¢å¤§ç›˜æ§åˆ¶é¢æ¿ï¼Œç‚¹å‡»å³ä¸Šè§’çš„æµè§ˆå™¨æ’ä»¶å›¾æ ‡ï¼Œå¬å”¤æ‰©å±•å°å¼¹çª—å³å¯å¼€å§‹é‡å¡‘å¼•æ“ç»“æ„ï¼', 'ğŸ§¹ æ¸…é™¤æˆåŠŸ');
                        window.close();
                    } else {
                        await cAlert('âŒ é‡ç½®å¤±è´¥: ' + (JSON.stringify(res) || 'åŸå› æœªçŸ¥'));
                        forceReinitBtn.innerText = 'âš ï¸ å¼ºåˆ¶é‡ç½®ç«¯ä¾§æ¨¡å‹';
                        forceReinitBtn.disabled = false;
                    }
                });
            }
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function loadData() {
        chrome.runtime.sendMessage({ type: 'GET_DASHBOARD_DATA' }, (res) => {
            if (!res || !res.success) {
                engineStatusEl.innerText = 'æœªåˆå§‹åŒ– / é”™è¯¯';
                engineStatusEl.style.color = '#f44336';
                return;
            }

            totalBookmarksEl.innerText = res.total || 0;
            const xCount = (res.xBookmarks || []).length;
            if (totalXBookmarksEl) totalXBookmarksEl.innerText = xCount;

            if (res.isInitialized) {
                engineStatusEl.innerText = 'âœ… æ¨¡å‹å·²å°±ç»ª';
                engineStatusEl.style.color = '#10b981';
            } else {
                engineStatusEl.innerText = 'ğŸ”„ åˆå§‹åŒ–ä¸­...';
                engineStatusEl.style.color = '#f59e0b';
            }

            // --- æ¸²æŸ“åˆ†ç±»æ–‡ä»¶å¤¹ ---
            const foldersArray = Object.entries(res.folders || {}).sort((a, b) => b[1].length - a[1].length);
            if (totalFoldersEl) totalFoldersEl.innerText = foldersArray.length;

            if (indexViewEl) {
                indexViewEl.innerHTML = '';
                if (foldersArray.length === 0) {
                    indexViewEl.innerHTML = '<div style="color: #999; text-align: center; padding: 40px;">æš‚æ— ä¹¦ç­¾æ•°æ®</div>';
                } else {
                    foldersArray.forEach(([path, bookmarks]) => {
                        const div = document.createElement('div');
                        div.className = 'folder-item';

                        let bmsHtml = bookmarks.map(b => `
                            <div class="bm-row">
                                <a href="${escapeHtml(b.url)}" target="_blank" class="bm-title">${escapeHtml(b.title || 'æ— æ ‡é¢˜')}</a>
                                <div class="bm-url">${escapeHtml(b.url)}</div>
                            </div>
                        `).join('');

                        div.innerHTML = `
                            <div class="folder-title">
                                <span>ğŸ“ ${escapeHtml(path)}</span>
                                <span class="folder-status">${bookmarks.length} æ¡</span>
                            </div>
                            <div class="folder-content">
                                ${bmsHtml}
                            </div>
                        `;

                        // ç‚¹å‡»å±•å¼€æŠ˜å 
                        div.querySelector('.folder-title').addEventListener('click', function () {
                            const content = this.nextElementSibling;
                            content.classList.toggle('open');
                        });

                        indexViewEl.appendChild(div);
                    });
                }
            }

            // --- æ¸²æŸ“æ¨ç‰¹ä¸“å±è§†å›¾åˆå§‹çŠ¶æ€ ---
            if (xListPane && !xListPane.querySelector('.folder-item')) {
                const rawCountLabel = document.getElementById('rawCountLabel');
                if (xCount === 0) {
                    if (rawCountLabel) {
                        rawCountLabel.parentElement.innerHTML = `
                            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ¦</div>
                            <div>ä½ è¿˜æ²¡æœ‰åŒæ­¥è¿‡æ¨ç‰¹çŸ¥è¯†åº“å“¦ã€‚<br><br>ç‚¹å‡»å³ä¸Šè§’çš„ <b style="color:var(--accent);">åŒæ­¥æ–°çš„æ¨ç‰¹ä¹¦ç­¾</b> æŒ‰é’®å»åŒæ­¥å§ï¼</div>
                        `;
                    }
                } else {
                    if (rawCountLabel) rawCountLabel.innerHTML = `å…±æœ‰ <b>${xCount}</b> æ¡æ¨ç‰¹ä¹¦ç­¾ã€‚`;
                }
            }
        });
    }

    const categorizeTwitterBtn = document.getElementById('categorizeTwitterBtn');
    const twitterCategorizeStatus = document.getElementById('twitterCategorizeStatus');

    // --- å…¨å±€çŠ¶æ€ï¼šå½“å‰å¾…ä¿å­˜çš„èšç±»è‰ç¨¿ (folderName -> [bookmarkId]) ---
    window.currentDrafts = {};

    function renderTwitterFolderSection(categoryName, bookmarks, isUserFolder, containerEl) {
        const div = document.createElement('div');
        div.className = 'folder-item';
        const bmIds = bookmarks.map(b => b.id);
        const borderColor = isUserFolder ? 'var(--success-text)' : 'var(--warning-text)';
        const badge = isUserFolder ? 'å·²ä¿å­˜' : 'å¾…ä¿å­˜è‰ç¨¿';
        const badgeStyle = isUserFolder ? 'background:var(--success-bg); color:var(--success-text); border:1px solid var(--success-border);' : 'background:var(--warning-bg); color:var(--warning-text); border:1px solid var(--warning-bg);';

        // ç»‘å®šæ•´ä¸ªåˆ—è¡¨é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼ˆéæ–‡ä»¶å¤¹å†…å®¹å±•å¼€ï¼‰
        let bmsHtml = bookmarks.length > 0 ? bookmarks.map((b, i) => {
            let author = 'æœªçŸ¥ä½œè€…', text = b.title;
            let meta = { retweets: '-', likes: '-', views: '-', mediaUrl: '' };

            const metaMatch = b.title.match(/\u200B({.*?})\u200B$/);
            if (metaMatch) {
                try {
                    meta = JSON.parse(metaMatch[1]);
                    text = text.replace(/\u200B{.*?}\u200B$/, '');
                } catch (e) { }
            }

            const match = text.match(/\[Xæ¨æ–‡\]\s*(.*?):\s*(.*)/);
            if (match) { author = match[1]; text = match[2]; }

            let handle = '';
            const handleMatch = b.url.match(/https?:\/\/(?:twitter|x)\.com\/([^\/]+)/i);
            if (handleMatch) handle = handleMatch[1];

            const avatarUrl = meta.authorAvatar || (handle ? `https://unavatar.io/twitter/${handle}?fallback=false` : '');

            // ä¸ºäº†å®‰å…¨ä¼ é€’æ•°æ®ç»™ DOM
            const bmDataStr = JSON.stringify({
                id: b.id, url: b.url, author, handle, text, meta,
                isUserFolder, folderName: categoryName
            }).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

            return `
                <div class="tw-list-item" data-bm='${bmDataStr}' title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">
                    ${avatarUrl ? `<img src="${avatarUrl}" class="list-avatar avatar-img" />` : `<div class="list-avatar">${author.charAt(0).toUpperCase()}</div>`}
                    <div class="list-content">
                        <div class="list-header">
                            <div style="display:flex; flex-direction:column;">
                                <span class="list-name">${escapeHtml(author)}</span>
                                ${handle ? `<span class="list-handle">@${escapeHtml(handle)}</span>` : ''}
                            </div>
                            <span style="font-size:12px; color:var(--text-muted); white-space:nowrap;">${meta.views !== '-' ? meta.views : ''}</span>
                        </div>
                        <div class="list-snippet">${escapeHtml(text)}</div>
                        ${meta.mediaUrl ? '<div style="font-size:12px; color:var(--accent); margin-top:4px;">ğŸ–¼ï¸ åŒ…å«åª’ä½“å†…å®¹</div>' : ''}
                    </div>
                </div>`;
        }).join('') : `<div style="padding: 20px; color: var(--text-sec); text-align:center;">æš‚æ— æ¨æ–‡</div>`;

        div.innerHTML = `
            <div class="folder-title" style="border-left: 3px solid ${borderColor}; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap: 8px;">
                    <span class="folder-name-text" style="color:var(--text-main);">ğŸ“ ${escapeHtml(categoryName)}</span>
                    <span class="folder-status">${bookmarks.length}</span>
                    <span style="font-size:10px; padding:2px 6px; border-radius:4px; ${badgeStyle}">${badge}</span>
                </div>
            </div>
            <div class="folder-content">
                <div style="padding: 8px; border-bottom: 1px solid var(--border-color); background: var(--bg-surface); display:flex; gap: 6px; flex-wrap: wrap;">
                    <button class="btn btn-rename" data-oldname="${escapeHtml(categoryName)}" data-isuser="${isUserFolder}" style="padding: 4px 8px; font-size: 11px;">âœï¸ å‘½å</button>
                    ${isUserFolder ? `<button class="btn btn-save-rename btn-success" data-oldname="${escapeHtml(categoryName)}" data-actual-old="${escapeHtml(categoryName)}" style="display:none; padding: 4px 8px; font-size: 11px;">ğŸ’¾ ä¿å­˜åå­—</button>` : ''}
                    ${!isUserFolder ? `<button class="btn btn-sync-folder btn-success" data-name="${escapeHtml(categoryName)}" data-ids='${JSON.stringify(bmIds)}' style="padding: 4px 8px; font-size: 11px;">ğŸ’¾ å½’æ¡£å…¥åº“</button>` : ''}
                    <button class="btn btn-delete-folder" data-name="${escapeHtml(categoryName)}" data-isuser="${isUserFolder}" style="padding: 4px 8px; font-size: 11px; color: var(--danger-btn);">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
                ${bmsHtml}
            </div>`;

        // ç»‘å®šå„ç§æ–‡ä»¶å¤¹è‡ªèº«çš„äº‹ä»¶
        // Rename (Draft or Saved)
        const renameBtn = div.querySelector('.btn-rename');
        if (renameBtn) {
            renameBtn.addEventListener('click', async function (e) {
                e.stopPropagation();
                const oldName = this.getAttribute('data-oldname');
                const isUserF = this.getAttribute('data-isuser') === 'true';
                const newName = await cPrompt(`ç»™è¿™æ‰¹æ¨æ–‡æ–‡ä»¶å¤¹èµ·ä¸ªæ–°åå­—ï¼š`, oldName);
                if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
                    const trimmed = newName.trim();
                    if (isUserF) {
                        div.querySelector('.folder-name-text').innerHTML = 'ğŸ“ ' + escapeHtml(trimmed) + ' <span style="color:var(--warning-text);font-size:12px;">(ğŸ“ å¾…ä¿å­˜)</span>';

                        const saveRenameBtn = div.querySelector('.btn-save-rename');
                        if (saveRenameBtn) {
                            const actualOld = saveRenameBtn.getAttribute('data-actual-old') || oldName;
                            saveRenameBtn.setAttribute('data-newname', trimmed);
                            saveRenameBtn.style.display = 'inline-block';

                            window.pendingRenames = window.pendingRenames || {};
                            window.pendingRenames[actualOld] = trimmed;
                        }

                        this.setAttribute('data-oldname', trimmed);
                    } else {
                        div.querySelector('.folder-name-text').innerHTML = 'ğŸ“ ' + escapeHtml(trimmed);
                        div.querySelectorAll('[data-name]').forEach(el => el.setAttribute('data-name', trimmed));
                        this.setAttribute('data-oldname', trimmed);
                        if (window.currentDrafts[oldName]) {
                            window.currentDrafts[trimmed] = window.currentDrafts[oldName];
                            delete window.currentDrafts[oldName];
                        } else {
                            window.currentDrafts[trimmed] = bmIds;
                        }
                    }
                }
            });
        }

        // Save rename (Saved folders)
        const saveRenameBtn = div.querySelector('.btn-save-rename');
        if (saveRenameBtn) {
            saveRenameBtn.addEventListener('click', async function (e) {
                e.stopPropagation();
                const oName = this.getAttribute('data-actual-old');
                const nName = this.getAttribute('data-newname');
                this.innerText = 'â³ ä¿å­˜ä¸­...';
                this.disabled = true;
                chrome.runtime.sendMessage({ type: 'RENAME_TWITTER_FOLDER', oldName: oName, newName: nName }, async (res) => {
                    if (res && res.success) {
                        this.style.display = 'none';
                        this.innerText = 'ğŸ’¾ ä¿å­˜åå­—';
                        this.disabled = false;
                        div.querySelector('.folder-name-text').innerHTML = 'ğŸ“ ' + escapeHtml(nName);

                        this.setAttribute('data-actual-old', nName);
                        if (renameBtn) renameBtn.setAttribute('data-oldname', nName);
                        div.querySelectorAll('[data-name]').forEach(el => el.setAttribute('data-name', nName));

                        if (window.pendingRenames) delete window.pendingRenames[oName];
                        await cAlert('âœ… ç¼–è¾‘å·²ä¿å­˜');
                    } else {
                        this.innerText = 'ğŸ’¾ ä¿å­˜å¤±è´¥';
                        this.disabled = false;
                        cAlert('âŒ ä¿å­˜å¤±è´¥:' + res?.error);
                    }
                });
            });
        }

        // Sync folder
        const syncBtn = div.querySelector('.btn-sync-folder');
        if (syncBtn) {
            syncBtn.addEventListener('click', async function (e) {
                e.stopPropagation();
                const folderName = this.getAttribute('data-name');
                const ids = JSON.parse(this.getAttribute('data-ids'));
                const confirmed = await cConfirm(`æ­¤æ“ä½œå°†åœ¨ Chrome ä¸­å»ºçœŸå®æ–‡ä»¶å¤¹å­˜æ”¾ <b>${escapeHtml(folderName)}</b> ä¹¦ç­¾ï¼Œä½ ç¡®å®šä¿å­˜å—ï¼Ÿ`);
                if (!confirmed) return;
                const btn = this;
                btn.innerText = 'â³ ä¿å­˜ä¸­...';
                btn.disabled = true;
                chrome.runtime.sendMessage({ type: 'SYNC_MULTIPLE_TWITTER_FOLDERS', folders: { [folderName]: ids } }, async (res) => {
                    if (res && res.success) {
                        delete window.currentDrafts[folderName];
                        btn.style.display = 'none';
                        await cAlert(`âœ… æˆåŠŸä¿å­˜ï¼`);
                        div.querySelector('.folder-name-text').parentElement.querySelector('span:last-child').innerText = 'å·²ä¿å­˜';
                        div.querySelector('.folder-name-text').parentElement.querySelector('span:last-child').style = 'background:var(--success-bg); color:var(--success-text); border:1px solid var(--success-border); padding:2px 6px; border-radius:4px; font-size:10px;';
                        div.querySelector('.folder-title').style.borderLeftColor = 'var(--success-text)';
                    } else {
                        await cAlert('âŒ ä¿å­˜å¤±è´¥: ' + (res?.error || 'æœªçŸ¥é”™è¯¯'));
                        btn.innerText = 'ğŸ’¾ ä¿å­˜å¤±è´¥ï¼Œé‡è¯•';
                        btn.disabled = false;
                    }
                });
            });
        }

        // Folder toggle
        div.querySelector('.folder-title').addEventListener('click', function (e) {
            if (e.target.tagName.toLowerCase() === 'button') return;
            this.nextElementSibling.classList.toggle('open');
        });

        // æ³¨å…¥åˆ° DOM åï¼Œå†ç»‘å®šè¯¦ç»†æ¨æ–‡çš„ç‚¹å‡»äº‹ä»¶ï¼ˆTwillotå¤§è§†å›¾ï¼‰
        const twListItems = div.querySelectorAll('.tw-list-item');
        twListItems.forEach(item => {
            item.addEventListener('click', function () {
                // ç§»é™¤å…¶ä»–é€‰ä¸­æ€
                document.querySelectorAll('.tw-list-item').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');

                const data = JSON.parse(this.getAttribute('data-bm').replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                renderDetailPane(data, this);
            });
        });

        // Delete folder
        const deleteBtn = div.querySelector('.btn-delete-folder');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async function (e) {
                e.stopPropagation();
                const folderName = this.getAttribute('data-name');
                const isUserF = this.getAttribute('data-isuser') === 'true';

                const confirmed = await cConfirm(`ç¡®å®šè¦å½»åº•åˆ é™¤ ${isUserF ? 'å·²ä¿å­˜åˆ†ç±»' : 'ä¸´æ—¶è‰ç¨¿'} <b>${escapeHtml(folderName)}</b> åŠé‡Œé¢æ‰€æœ‰çš„æ¨æ–‡å—ï¼Ÿ<br><br><b>è­¦å‘Šï¼šè¿™ä¼šå¯¼è‡´è¿™äº›ä¹¦ç­¾ä» Chrome ä¸­æ°¸ä¹…æŠ¹é™¤ï¼</b>`);
                if (confirmed) {
                    this.innerText = 'â³ åˆ é™¤ä¸­...';
                    this.disabled = true;
                    if (isUserF) {
                        chrome.runtime.sendMessage({ type: 'DELETE_TWITTER_FOLDER', folderName }, async (res) => {
                            if (res && res.success) {
                                div.style.transition = 'opacity 0.3s, max-height 0.3s';
                                div.style.opacity = '0';
                                div.style.maxHeight = '0';
                                div.style.overflow = 'hidden';
                                setTimeout(() => div.remove(), 300);
                            } else {
                                this.innerText = 'ğŸ—‘ï¸ é‡è¯•';
                                this.disabled = false;
                                cAlert('âŒ åˆ é™¤å¤±è´¥:' + res?.error);
                            }
                        });
                    } else {
                        chrome.runtime.sendMessage({ type: 'DELETE_MULTIPLE_BOOKMARKS', bookmarkIds: bmIds }, async (res) => {
                            if (res && res.success) {
                                delete window.currentDrafts[folderName];
                                div.style.transition = 'opacity 0.3s, max-height 0.3s';
                                div.style.opacity = '0';
                                div.style.maxHeight = '0';
                                div.style.overflow = 'hidden';
                                setTimeout(() => div.remove(), 300);
                            } else {
                                this.innerText = 'ğŸ—‘ï¸ é‡è¯•';
                                this.disabled = false;
                                cAlert('âŒ åˆ é™¤å¤±è´¥:' + res?.error);
                            }
                        });
                    }
                }
            });
        }

        containerEl.appendChild(div);
    }

    // æ¸²æŸ“è¯¦æƒ…é¢æ¿å¹¶åœ¨æŠ½å±‰ä¸­æ‰“å¼€
    function renderDetailPane(data, listItemElement) {
        const xDetailPane = document.getElementById('xDetailPane');
        if (!xDetailPane) return;

        const avatarUrl = data.meta.authorAvatar || (data.handle ? `https://unavatar.io/twitter/${data.handle}?fallback=false` : '');

        xDetailPane.innerHTML = `
            <div class="detail-container">
                <div class="detail-author-row">
                    <div class="detail-author-left">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="detail-avatar avatar-img" />` : `<div class="detail-avatar" style="display:flex; align-items:center; justify-content:center; color:var(--text-sec); font-size:24px;">${data.author.charAt(0).toUpperCase()}</div>`}
                        <div class="detail-name-row">
                            <span class="detail-name">${escapeHtml(data.author)}</span>
                            ${data.handle ? `<span class="detail-handle">@${escapeHtml(data.handle)}</span>` : ''}
                        </div>
                    </div>
                    <a href="${escapeHtml(data.url)}" target="_blank" class="btn btn-primary" style="text-decoration:none;">æŸ¥çœ‹åŸæ¨ â†—</a>
                </div>
                
                <div class="detail-text">${escapeHtml(data.text)}</div>
                
                ${data.meta.mediaUrl ? `
                <div class="detail-media">
                    <img src="${data.meta.mediaUrl}" class="media-thumb" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾" />
                </div>` : ''}

                <div class="detail-stats">
                    <span title="æµè§ˆé‡">ğŸ‘€ ${data.meta.views || '-'}</span>
                    <span title="ç‚¹èµæ•°">â¤ï¸ ${data.meta.likes || '-'}</span>
                    <span title="è½¬å‘æ•°">ğŸ” ${data.meta.retweets || '-'}</span>
                    <span style="margin-left:auto; font-size:12px;" class="list-folder-badge">ğŸ“ ${escapeHtml(data.folderName)}</span>
                </div>

                <div class="detail-actions">
                    <button class="btn btn-primary btn-dispatch-detail" data-id="${data.id}">ğŸª„ æ™ºèƒ½ç§»åŠ¨è‡³ä¸»åº“</button>
                    <button class="btn btn-danger btn-delete-bm-detail" data-id="${data.id}">ğŸ—‘ï¸ æ°¸ä¹…åˆ é™¤æ­¤æ¨</button>
                </div>
            </div>
        `;

        // é‡æ–°ç»‘å®šå›¾ç‰‡çš„ç‚¹å‡»
        const mediaThumb = xDetailPane.querySelector('.media-thumb');
        if (mediaThumb) {
            // äº‹ä»¶å§”æ‰˜å·²ç»åœ¨é¡¶éƒ¨å¤„ç†äº†ï¼Œè¿™é‡Œåªéœ€è¦ class æ˜¯ media-thumb å°±ä¼šè§¦å‘
        }

        // ç»‘å®šåŠ¨ä½œ
        const dispatchBtn = xDetailPane.querySelector('.btn-dispatch-detail');
        if (dispatchBtn) {
            dispatchBtn.addEventListener('click', async function () {
                const id = this.getAttribute('data-id');
                this.innerText = 'â³ åŒ¹é…ä¸­...';
                this.disabled = true;
                chrome.runtime.sendMessage({ type: 'SMART_DISPATCH_SINGLE_TWITTER', bookmarkId: id }, async (res) => {
                    if (res && res.success) {
                        const p = Math.round(res.confidence * 100);
                        const confirmed = await cConfirm(`ğŸ¯ <b>è¯­ä¹‰åŒ¹é…æˆåŠŸï¼</b><br><br>æ¨èä¸»åº“åˆ†ç±»ï¼š<br>ğŸ“ <b style="color:var(--accent);">${res.suggestedFolder}</b> (${p}% å¥‘åˆåº¦)<br><br>æ˜¯å¦åŒæ„æ´¾å‘ï¼Ÿ`);
                        if (confirmed) {
                            chrome.runtime.sendMessage({ type: 'MOVE_BOOKMARK', bookmarkId: id, parentId: res.suggestedFolderId }, async (mv) => {
                                if (mv && mv.success) {
                                    await cAlert('âœ… æ´¾å‘æˆåŠŸã€‚');
                                    listItemElement.remove();
                                    if (typeof window.closeTwDrawer === 'function') window.closeTwDrawer();
                                } else {
                                    await cAlert('âŒ ç§»åŠ¨å¤±è´¥ï¼š' + mv?.error);
                                    this.innerText = 'ğŸª„ é‡è¯•';
                                    this.disabled = false;
                                }
                            });
                        } else {
                            this.innerText = 'ğŸª„ æ™ºèƒ½ç§»åŠ¨è‡³ä¸»åº“';
                            this.disabled = false;
                        }
                    } else {
                        await cAlert('âŒ åŒ¹é…è½é€‰ï¼š' + (res?.error || 'æœªçŸ¥é”™è¯¯'));
                        this.innerText = 'ğŸª„ æ™ºèƒ½ç§»åŠ¨è‡³ä¸»åº“';
                        this.disabled = false;
                    }
                });
            });
        }

        const deleteBmBtn = xDetailPane.querySelector('.btn-delete-bm-detail');
        if (deleteBmBtn) {
            deleteBmBtn.addEventListener('click', async function () {
                const id = this.getAttribute('data-id');
                const confirmed = await cConfirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æ¨æ–‡ä¹¦ç­¾å—ï¼Ÿ<br><br>è¿™å°†åœ¨æµè§ˆå™¨ä¸­çœŸå®åœ°å°†å…¶æŠ¹é™¤ï¼`);
                if (confirmed) {
                    this.innerText = 'â³ åˆ é™¤ä¸­..';
                    this.disabled = true;
                    chrome.runtime.sendMessage({ type: 'DELETE_BOOKMARK', bookmarkId: id }, async (res) => {
                        if (res && res.success) {
                            listItemElement.style.opacity = '0';
                            setTimeout(() => listItemElement.remove(), 300);
                            if (typeof window.closeTwDrawer === 'function') window.closeTwDrawer();
                        } else {
                            await cAlert('âŒ åˆ é™¤å¤±è´¥ï¼š' + res?.error);
                            this.innerText = 'ğŸ—‘ï¸ é‡è¯•';
                            this.disabled = false;
                        }
                    });
                }
            });
        }

        // æ‰“å¼€ Drawer
        const twDrawerOverlay = document.getElementById('twDrawerOverlay');
        const twDrawerPanel = document.getElementById('twDrawerPanel');
        if (twDrawerOverlay && twDrawerPanel) {
            twDrawerOverlay.classList.add('open');
            twDrawerPanel.classList.add('open');
        }
    }

    if (categorizeTwitterBtn) {
        categorizeTwitterBtn.addEventListener('click', () => {
            categorizeTwitterBtn.innerText = 'ğŸ§  æ­£åœ¨æ·±åº¦è¯­ä¹‰å½’ç±»...';
            categorizeTwitterBtn.disabled = true;
            twitterCategorizeStatus.style.display = 'block';
            twitterCategorizeStatus.innerHTML = 'æ­£åœ¨ç”¨ç«¯ä¾§å¤§æ¨¡å‹æå–ç‰¹å¾å¹¶èšç±»ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´...';

            chrome.runtime.sendMessage({ type: 'CLUSTER_TWITTER_BOOKMARKS' }, (res) => {
                categorizeTwitterBtn.innerText = 'ğŸ”® é‡æ–°æå–ç‰¹å¾å¹¶èšç±»';
                categorizeTwitterBtn.disabled = false;

                if (!res || !res.success) {
                    twitterCategorizeStatus.innerHTML = `âŒ åˆ†æå¤±è´¥: ${res?.error || 'æœªçŸ¥é”™è¯¯'}`;
                    twitterCategorizeStatus.className = 'status-banner status-warning';
                    return;
                }

                twitterCategorizeStatus.style.display = 'none';

                // Clear xListPane
                xListPane.innerHTML = '';

                // Setup control buttons
                twActionControls.style.display = 'flex';
                twActionControls.innerHTML = '';

                const addFolderBtn = document.createElement('button');
                addFolderBtn.className = 'btn btn-primary';
                addFolderBtn.innerHTML = 'â• æ–°å»ºè‰ç¨¿åˆ†ç±»';
                addFolderBtn.addEventListener('click', async () => {
                    const folderName = await cPrompt('æ–°åˆ†ç±»åç§°ï¼š', '', 'â• æ–°å»ºè‰ç¨¿åˆ†ç±»');
                    if (folderName && folderName.trim()) {
                        const trimmed = folderName.trim();
                        window.currentDrafts[trimmed] = window.currentDrafts[trimmed] || [];
                        renderTwitterFolderSection(trimmed, [], false, xListPane);
                    }
                });

                const saveAllBtn = document.createElement('button');
                saveAllBtn.className = 'btn btn-success';
                saveAllBtn.innerHTML = 'ğŸ’¾ ä¸€é”®ä¿å­˜å…¨éƒ¨è‰ç¨¿';
                saveAllBtn.addEventListener('click', async () => {
                    if (Object.keys(window.currentDrafts || {}).length === 0 && Object.keys(window.pendingRenames || {}).length === 0) {
                        return cAlert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„è‰ç¨¿æˆ–ä¿®æ”¹ã€‚');
                    }
                    saveAllBtn.innerText = 'â³ ä¿å­˜ä¸­...';
                    saveAllBtn.disabled = true;
                    chrome.runtime.sendMessage({ type: 'SYNC_MULTIPLE_TWITTER_FOLDERS', folders: window.currentDrafts, renames: window.pendingRenames }, async (saveRes) => {
                        if (saveRes && saveRes.success) {
                            window.currentDrafts = {};
                            window.pendingRenames = {};
                            saveAllBtn.innerText = 'âœ… å…¨éƒ¨ä¿å­˜æˆåŠŸ';
                            document.querySelectorAll('.btn-save-rename').forEach(b => b.style.display = 'none');
                            document.querySelectorAll('.btn-sync-folder').forEach(b => b.style.display = 'none');
                            await cAlert(`âœ… å…¨éƒ¨è‰ç¨¿å’Œä¿®æ”¹å·²åŒæ­¥åˆ°æµè§ˆå™¨ä¸­ï¼<br>è¯·ç‚¹å‡»ã€åˆ·æ–°æ•°æ®ã€‘åŠ è½½æœ€æ–°ç»“æ„ã€‚`);
                        } else {
                            await cAlert('âŒ æ‰¹é‡ä¿å­˜å¤±è´¥: ' + (saveRes?.error || 'æœªçŸ¥é”™è¯¯'));
                            saveAllBtn.innerText = 'ğŸ’¾ ä¸€é”®ä¿å­˜å…¨éƒ¨è‰ç¨¿';
                            saveAllBtn.disabled = false;
                        }
                    });
                });

                twActionControls.appendChild(addFolderBtn);
                twActionControls.appendChild(saveAllBtn);

                const userFolders = res.userFolders || {};
                const autoClusters = res.autoClusters || {};

                window.currentDrafts = {};
                for (const [name, bms] of Object.entries(autoClusters)) {
                    if (name.includes('ğŸ“Œ æœªå½’ç±»æ¨æ–‡')) continue;
                    window.currentDrafts[name] = bms.map(b => b.id);
                }

                // Render auto clusters (drafts)
                for (const [name, bms] of Object.entries(autoClusters)) {
                    renderTwitterFolderSection(name, bms, false, xListPane);
                }

                // Render existing browser folders
                if (Object.keys(userFolders).length > 0) {
                    const existingHeader = document.createElement('div');
                    existingHeader.innerHTML = '<div style="padding: 10px 20px; font-weight:600; color:var(--success-text); background:var(--success-bg); border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color);">ğŸŒ å·²åœ¨æµè§ˆå™¨ä¸­çš„åˆ†ç±»åº“</div>';
                    xListPane.appendChild(existingHeader);

                    for (const [name, bms] of Object.entries(userFolders)) {
                        renderTwitterFolderSection(name, bms, true, xListPane);
                    }
                }
            });
        });
    }

    // --- è¯­ä¹‰æœç´¢é€»è¾‘ ---
    const dashSearchInput = document.getElementById('dashSearchInput');
    const dashSearchBtn = document.getElementById('dashSearchBtn');
    const tabSearchBtn = document.getElementById('tabSearchBtn');
    const searchView = document.getElementById('searchView');
    const searchStatus = document.getElementById('searchStatus');

    function performSearch() {
        const query = dashSearchInput.value.trim();
        if (!query) {
            cAlert('è¯·è¾“å…¥æœç´¢å…³é”®è¯ã€‚');
            return;
        }

        dashSearchBtn.innerText = 'â³ æœç´¢ä¸­...';
        dashSearchBtn.disabled = true;

        chrome.runtime.sendMessage({
            type: 'SEARCH_BOOKMARKS',
            query: query,
            topK: 50
        }, (res) => {
            dashSearchBtn.innerText = 'ğŸ” è¯­ä¹‰æœç´¢';
            dashSearchBtn.disabled = false;

            if (res && res.success) {
                // Switch to search tab
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                tabSearchBtn.style.display = 'inline-block';
                tabSearchBtn.classList.add('active');
                document.getElementById('tab-search').classList.add('active');

                searchStatus.style.display = 'block';
                searchStatus.innerHTML = `å·²ä¸ºæ‚¨æ‰¾åˆ° <b>${res.results.length}</b> æ¡ä¸ "<b>${escapeHtml(query)}</b>" é«˜åº¦ç›¸å…³çš„ç»“æœï¼š`;

                searchView.innerHTML = res.results.map((b, i) => {
                    const similarity = b.score || b.similarity || 0;
                    const p = Math.round(similarity * 100);
                    return `
                        <div class="bm-row" style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.02); flex-direction: row; align-items: center; justify-content: space-between;">
                            <div style="flex: 1; min-width: 0;">
                                <a href="${escapeHtml(b.url)}" target="_blank" class="bm-title" style="font-size: 15px; color: #1e40af; text-decoration: none; font-weight: 600;">${escapeHtml(b.title || 'æ— æ ‡é¢˜')}</a>
                                <div class="bm-url" style="margin-top: 6px; font-size: 13px; color: #64748b;">${escapeHtml(b.url)}</div>
                            </div>
                            <div style="text-align: right; margin-left: 15px;">
                                <span style="font-size: 12px; font-weight: bold; color: ${p >= 80 ? '#047857' : (p >= 60 ? '#b45309' : '#475569')}; background: ${p >= 80 ? '#d1fae5' : (p >= 60 ? '#fef3c7' : '#f1f5f9')}; padding: 4px 8px; border-radius: 4px; border: 1px solid ${p >= 80 ? '#34d399' : (p >= 60 ? '#fcd34d' : '#cbd5e1')};">å¥‘åˆåº¦ ${p}%</span>
                            </div>
                        </div>
                    `;
                }).join('');

                if (res.results.length === 0) {
                    searchView.innerHTML = `<div style="text-align: center; padding: 60px; color: #64748b; font-size: 15px;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œæ‚¨çš„è¡¨è¾¾å¤ªä¸ªæ€§åŒ–ï¼Œè¿˜æ˜¯æ¨¡å‹å¤ªç¬¨å•¦ï¼Ÿå°è¯•æ¢ä¸ªè¯´æ³•å§ï½</div>`;
                }

            } else {
                cAlert('æœç´¢å¤±è´¥ï¼š' + (res?.error || 'æ¨¡å‹å°šæœªå°±ç»ªï¼Œè¯·ç¨å'));
            }
        });
    }

    if (dashSearchBtn) {
        dashSearchBtn.addEventListener('click', performSearch);
    }

    if (dashSearchInput) {
        dashSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }

    loadData();
});
